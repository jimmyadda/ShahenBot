<!doctype html>
<html lang="en" dir="rtl">
<head>
    <meta charset="utf-8">
    <title>ShahenBot – Payments</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
    >
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- ... התוכן שלך ... -->

<!-- Bootstrap JS (bundle כולל Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            background: linear-gradient(135deg, #f3f6ff 0%, #fdfdfd 40%, #f5f5f5 100%);
            min-height: 100vh;
        }

        .navbar-brand {
            font-weight: 700;
            letter-spacing: 0.03em;
        }

        .navbar {
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
        }

        .page-title {
            font-weight: 700;
            letter-spacing: 0.03em;
        }

        .page-subtitle {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .card {
            border-radius: 1rem;
            box-shadow: 0 6px 20px rgba(15, 23, 42, 0.06);
            border: none;
        }

        .card-header {
            border-radius: 1rem 1rem 0 0 !important;
            background: linear-gradient(135deg, #0d6efd 0%, #0b5ed7 60%, #0a58ca 100%);
            color: #fff;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .filter-card {
            border-radius: 1rem;
            box-shadow: 0 4px 16px rgba(15, 23, 42, 0.05);
            border: none;
        }

        .filter-label {
            font-weight: 500;
            font-size: 0.85rem;
        }

        .badge-pill {
            border-radius: 999px;
        }

        .table thead th {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }

        .table tbody td {
            font-size: 0.9rem;
        }
    </style>
</head>
<body class="pb-4">

    <form method="get" class="row g-2 align-items-end mb-3">
  <div class="col-md-4">
    <label class="form-label">בניין</label>
    <select name="building_id" class="form-select">
      <option value="">כל הבניינים</option>
      {% for b in buildings %}
        <option value="{{b.id}}" {% if building_id==b.id %}selected{% endif %}>
          {{b.city}} {{b.street}} {{b.number}}{% if b.name %} ({{b.name}}){% endif %}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <label class="form-label">שנה</label>
    <input type="number" class="form-control" name="year" value="{{year or ''}}" placeholder="2025">
  </div>

  <div class="col-md-2">
    <label class="form-label">חודש</label>
    <select name="month" class="form-select">
      <option value="">הכל</option>
      {% for m in range(1,13) %}
        <option value="{{m}}" {% if month==m %}selected{% endif %}>{{m}}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-4 d-flex gap-2">
    <button class="btn btn-primary mt-4">סנן</button>
    <a class="btn btn-outline-secondary mt-4" href="/admin/payments">איפוס</a>
  </div>
</form>

<div class="container py-3" dir="rtl">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="m-0">אישורי תשלומים</h3>
    <a class="btn btn-outline-secondary" href="{{ url_for('admin_dashboard') }}">חזרה לדשבורד</a>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="alert alert-{{category}}">{{msg}}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if not payments %}
    <div class="alert alert-info">אין תשלומים ממתינים.</div>
  {% else %}
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>דייר</th>
            <th>דירה</th>
            <th>סכום</th>
            <th>שיטה</th>
            <th>נוצר</th>
            <th>אסמכתא</th>
            <th class="text-center">פעולות</th>
          </tr>
        </thead>
        <tbody>
        {% for p in payments %}
          <tr>
            <td>{{ p.id }}</td>
            <td>{{ p.tenant_name }}</td>
            <td>{{ p.apartment }}</td>
            <td>{{ "%.2f"|format((p.amount_cents or 0)/100) }} {{ p.currency or "ILS" }}</td>
            <td>{{ p.method }}</td>
            <td>{{ p.created_at }}</td>
            <td>
              {% if p.proof_file_id and p.proof_file_id != "TEMP" %}
                <a class="btn btn-sm btn-outline-primary"
                   href="/admin/payments/{{p.id}}/proof"
                   target="_blank">צפייה</a>
              {% else %}
                <span class="badge bg-danger">חסרה</span>
              {% endif %}
            </td>
            <td class="text-center">
              <div class="d-flex gap-2 justify-content-center flex-wrap">
                <button class="btn btn-success btn-sm"
                        data-bs-toggle="modal"
                        data-bs-target="#approveModal"
                        data-payment-id="{{p.id}}"
                        {% if not p.proof_file_id or p.proof_file_id=="TEMP" %}disabled{% endif %}>
                  ✅ אשר
                </button>

                <form method="post" action="/admin/payments/{{p.id}}/reject" class="d-flex gap-1">
                  <input name="note" class="form-control form-control-sm" style="max-width:220px"
                         placeholder="סיבת דחייה (אופציונלי)"
                         {% if not p.proof_file_id or p.proof_file_id=="TEMP" %}disabled{% endif %}>
                  <button class="btn btn-danger btn-sm"
                          {% if not p.proof_file_id or p.proof_file_id=="TEMP" %}disabled{% endif %}>
                    ❌ דחה
                  </button>
                </form>
              </div>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
</div>

<!-- Due payments / Overdue -->
<div class="card mt-4">
  <div class="card-header">
    תשלומים קרובים / באיחור
  </div>
  <div class="card-body">
    {% if (not due_now) and (not due_soon) %}
      <div class="alert alert-success m-0">אין דיירים עם תשלום קרוב/באיחור.</div>
    {% else %}
      <div class="row g-3">
        <div class="col-md-6">
          <h6 class="mb-2">באיחור (עד היום)</h6>
          <ul class="list-group">
            {% for t in due_now %}
              <li class="list-group-item d-flex justify-content-between">
                <span>{{t.name}} – דירה {{t.apartment}}</span>
                <span class="badge bg-danger badge-pill">{{t.next_payment_date}}</span>
              </li>
            {% endfor %}
            {% if not due_now %}
              <li class="list-group-item text-muted">אין</li>
            {% endif %}
          </ul>
        </div>

        <div class="col-md-6">
          <h6 class="mb-2">קרוב (14 ימים)</h6>
          <ul class="list-group">
            {% for t in due_soon %}
              <li class="list-group-item d-flex justify-content-between">
                <span>{{t.name}} – דירה {{t.apartment}}</span>
                <span class="badge bg-warning text-dark badge-pill">{{t.next_payment_date}}</span>
              </li>
            {% endfor %}
            {% if not due_soon %}
              <li class="list-group-item text-muted">אין</li>
            {% endif %}
          </ul>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<!-- Payments history -->
<div class="card mt-4">
  <div class="card-header">
    היסטוריית תשלומים מאושרים (לפי חודש/שנה)
  </div>
  <div class="card-body">

    <form method="get" class="row g-2 align-items-end mb-3">
      <input type="hidden" name="building_id" value="{{building_id}}">

      <div class="col-auto">
        <label class="filter-label">שנה</label>
        <select name="year" class="form-select">
          <option value="">הכל</option>
          {% for y in range(2023, 2031) %}
            <option value="{{y}}" {% if year==y %}selected{% endif %}>{{y}}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-auto">
        <label class="filter-label">חודש</label>
        <select name="month" class="form-select">
          <option value="">הכל</option>
          {% for m in range(1,13) %}
            <option value="{{m}}" {% if month==m %}selected{% endif %}>{{m}}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-auto">
        <button class="btn btn-primary">סנן</button>
        <a class="btn btn-outline-secondary" href="/admin/payments?building_id={{building_id}}">איפוס</a>
      </div>
    </form>

    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle">
        <thead>
          <tr>
            <th>#</th>
            <th>דייר</th>
            <th>דירה</th>
            <th>סכום</th>
            <th>שיטה</th>
            <th>תאריך</th>
          </tr>
        </thead>
        <tbody>
          {% for p in history %}
            <tr>
              <td>{{p.id}}</td>
              <td>{{p.tenant_name}}</td>
              <td>{{p.apartment}}</td>
              <td>{{ "%.2f"|format((p.amount_cents or 0)/100) }} {{ p.currency or "ILS" }}</td>
              <td>{{p.method}}</td>
              <td>{{p.created_at}}</td>
            </tr>
          {% endfor %}
          {% if not history %}
            <tr><td colspan="6" class="text-muted text-center">אין תשלומים מאושרים עבור הפילטר.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <div class="text-end fw-bold">
      סה״כ לתצוגה הנוכחית: {{ "%.2f"|format(total_sum) }} ₪
    </div>

  </div>
</div>


<!-- Modal: months -->
<div class="modal fade" id="approveModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" id="approveForm">
      <div class="modal-header">
        <h5 class="modal-title">אישור תשלום</h5>
        <button type="button" class="btn-close ms-0" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label class="form-label">תשלום הבא בעוד כמה חודשים?</label>
        <input type="number" name="months" class="form-control" min="1" max="120" value="1" required>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
        <button type="submit" class="btn btn-success">אשר ועדכן</button>
      </div>
    </form>
  </div>
</div>

<script>
  const approveModal = document.getElementById('approveModal');
  const approveForm = document.getElementById('approveForm');
  approveModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const paymentId = button.getAttribute('data-payment-id');
    approveForm.action = `/admin/payments/${paymentId}/approve`;
  });
</script>
</body>
</html>
